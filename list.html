<!DOCTYPE html>
<html manifest="nocache.appcache">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE =edge">
    <meta name="viewport" content="width =device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="images/icon.png" />
    <title>List</title>
    <style>
        input[type=text] {
            border: 1px solid #eeeeee;
            font-size:14px;
            padding:5px;
        }
        input[type=button],input[type=file] {
            margin-bottom: 5px;
            border-radius:25px;
            border:none;
            outline: none;
            padding: 5px;
            font-size: 14px;
        }
        input[type=checkbox]{
            vertical-align:bottom;border:1px solid red;
        }
        .type{
            width:7%
        }
        .qty{
            width:10%
        }
        .name{
            width:35%
        }
        .rem{
            width:28%
        }
        .hdr{
            border:none;
            font-weight:bold;
        }
        #dvList{
        }
    </style>
</head>
<body onload="initialize();">
    <div>
        <select id="ddlFilter">
            <option value="All">All</option>
            <option value="Selected">Selected</option>
            <option value="Unselected">Unselected</option>
        </select>
        <input type="button" value="Save" id="btnSave" />
        <input type="button" value="Export" id="btnExport" />
        <input type="button" value="Import" id="btnImport" />         
    </div>
    <div id="dvImport" style="display:none">
        <input type="file" id="fileImport" /><br />
        <input type="button" value="Merge" id="btnMerge" />
        <input type="button" value="Replace" id="btnReplace" /> 
    </div>
    <hr/>
    <div>
        <input type="text" value="Grp" class="type hdr"><input type="text" value="Name" class="name hdr"><input type="text" value="Remark" class="rem hdr"><input type="text" value="Qnty" class="qty hdr">
        <input type="button" value="+" id="btnAdd" class="add" />
    </div>
    <div id="dvList">
    </div>
    <script lang="javascript">
        document.getElementById("btnAdd").addEventListener("click", function () {
            addItem();
        });
        document.getElementById("btnSave").addEventListener("click", function () {
            saveList();
            toggleSave(false);
        });
        document.getElementById("btnImport").addEventListener("click", function () {
            toggleImport();
        });
        document.getElementById("btnReplace").addEventListener("click", function () {
            loadFile(1);
            toggleImport();
        });
        document.getElementById("btnMerge").addEventListener("click", function () {
            loadFile(0);
            toggleImport();
        });
        document.getElementById("btnExport").addEventListener("click", function () {
            saveAsFile(JSON.stringify(listData));
        });
        document.getElementById("ddlFilter").addEventListener("change", function () {
            filter();
        });

        var listData = [];
        function initialize() {
            listData = getCache();
            loadList();
        }
        function loadList() {
            type = document.getElementById("ddlFilter").selectedIndex;
            for (i = 0; i < listData.length; i++) {
                if((type == 0)
                   || (type == 1 && listData[i].Buy)
                   || (type == 2 && !listData[i].Buy)){
                        addToDiv(document.getElementById("dvList"), listData[i]);
                }
            }
        }
        function saveToList(item) {
            if (item.Id == null) {
                item.Id = getNextIndex();
                listData.push(item);
            }
            else {
                i = listData.findIndex((d => d.Id == item.Id));
                listData[i] = item;
            }
            toggleSave(true);
            return item;
        }
        function filter(){
            document.getElementById("dvList").innerHTML = "";
            loadList(document.getElementById("ddlFilter").selectedIndex);
        }
        function saveList() {
            setCache(listData);
        }
        function saveAsFile(data) {
            var a = document.createElement("a");
            a.download = "list";
            a.innerHTML = "export";
            a.href = window.URL.createObjectURL(new Blob([data], { type: "text/plain" }));
            a.style.display = "none";
            a.onclick = function (event) { document.body.removeChild(event.target); };
            document.body.appendChild(a);
            a.click();
        }
        function loadFile(replace) {
            var fileReader = new FileReader();
            fileReader.onload = function(event) {
                importedData = JSON.parse(event.target.result);
                if(replace){
                    listData = importedData;
                }
                else{
                    for (i = 0; i < importedData.length; i++) {
                        importedData[i].Id = getNextIndex();
                        listData.push(importedData[i]);
                    }
                }
                document.getElementById("dvList").innerHTML = "";
                loadList();
                toggleSave(true);
            };
            fileReader.readAsText(document.getElementById("fileImport").files[0], "UTF-8");
        }
        function addToDiv(d, item, addToTop) {
            dv = document.createElement('div');            
            tb = document.createElement('input');
            tb.setAttribute("type", "text");
            tb.setAttribute("itemId", item.Id);
            tb.id = "tbType" + item.Id;
            tb.value = item.Type;
            tb.className = "type";
            tb.addEventListener("blur", function () { saveItem(this); });
            dv.appendChild(tb);
            tb = document.createElement('input');
            tb.setAttribute("type", "text");
            tb.setAttribute("itemId", item.Id);
            tb.id = "tbName" + item.Id;
            tb.value = item.Name;
            tb.className = "name";
            tb.addEventListener("blur", function () { saveItem(this); });
            dv.appendChild(tb);
            tb = document.createElement('input');
            tb.setAttribute("type", "text");
            tb.setAttribute("itemId", item.Id);
            tb.id = "tbRemark" + item.Id;
            tb.value = item.Remark;
            tb.className = "rem";
            tb.addEventListener("blur", function () { saveItem(this); });
            dv.appendChild(tb);
            tb = document.createElement('input');
            tb.setAttribute("type", "text");
            tb.setAttribute("itemId", item.Id);
            tb.id = "tbQuantity" + item.Id;
            tb.value = item.Quantity;
            tb.className = "qty";
            tb.addEventListener("blur", function () { saveItem(this); });
            dv.appendChild(tb);
            tb = document.createElement('input');
            tb.setAttribute("type", "checkbox");
            tb.setAttribute("itemId", item.Id);
            tb.id = "cbBuy" + item.Id;
            tb.checked = item.Buy;
            tb.addEventListener("click", function () { saveItem(this); });
            dv.appendChild(tb);            
            if(addToTop){
                d.insertBefore(dv, d.firstChild);
            } else{
                d.appendChild(dv);
            }
        }
        function saveItem(element) {
            id = element.getAttribute("itemId");
            item = {
                Id: id,
                Type: document.getElementById("tbType" + id).value,
                Name: document.getElementById("tbName" + id).value,
                Remark: document.getElementById("tbRemark" + id).value,
                Quantity: document.getElementById("tbQuantity" + id).value,
                Buy: document.getElementById("cbBuy" + id).checked
            }
            saveToList(item);
        }
        function toggleSave(status){
            if (status) {
                document.getElementById("btnSave").style.color = "red"
            }
            else{
                document.getElementById("btnSave").style.color = "green"
            }
        }
        function toggleImport(){
            if (document.getElementById("dvImport").style.display == "none") {
                document.getElementById("dvImport").style.display = "block";
                document.getElementById("btnImport").value = "Cancel";
                document.getElementById("fileImport").value = "";
            }
            else{
                document.getElementById("dvImport").style.display = "none";
                document.getElementById("btnImport").value = "Import";
            }
        }        
        function addItem() {
            item = {Id: null, Type: null, Name: null, Remark: null, Quantity: null, Buy: false};
            item = saveToList(item);
            addToDiv(document.getElementById("dvList"), item, true);
        }
        function getNextIndex() {
            var index = localStorage.getItem("index_list");
            if (index == null) {
                index = 0;
            }
            else {
                index = parseInt(index);
            }
            index = index + 1;
            localStorage.setItem("index_list", index);
            return index;
        }
        function getCache() {
            var items = JSON.parse(localStorage.getItem("list"));
            if (items == null) {
                items = [];
            }
            return items;
        }
        function setCache(items) {
            localStorage.setItem("list", JSON.stringify(items));
        }
    </script>
</body>
</html>
