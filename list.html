<!DOCTYPE html>
<html manifest="nocache.appcache">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE =edge">
    <meta name="viewport" content="width =device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="images/icon.png" />
    <title>List</title>
    <style>
        input[type=text] {
            border: 1px solid #eeeeee;
            font-size:14px;
            padding:5px;
        }
         #tbNewType, .type{
            width:5%
        }
        #tbNewQuantity, .qty{
            width:10%
        }
        #tbNewName, .name{
            width:35%
        }
        #tbNewRemark, .rem{
            width:30%
        }
        input[type=checkbox]{
            vertical-align:bottom;border:1px solid red;
        }
    </style>
</head>
<body onload="initialize();">
    <div>
        <input type="button" value="Add" id="btnAdd" />
        <input type="button" value="Save" id="btnSave" />
        <input type="button" value="Export Text" id="btnExportTxt" />
        <input type="button" value="Export Data" id="btnExportData" />
        <input type="button" value="Import Data" id="btnImportData" />
        <hr/>
    </div>
    <div id="dvList">
    </div>
    <script lang="javascript">
        document.getElementById("btnAdd").addEventListener("click", function () {
            addItem();
        });
        document.getElementById("btnSave").addEventListener("click", function () {
            saveList();
        });
        document.getElementById("btnExportTxt").addEventListener("click", function () {
            saveAsFile(document.getElementById("dvList").innerText);
        });
        document.getElementById("btnExportData").addEventListener("click", function () {
            saveAsFile(JSON.stringify(listData));
        });

        var listData = [];
        function initialize() {
            listData = getCache();
            loadList();
        }
        function loadList() {
            for (i = 0; i < listData.length; i++) {
                addToDiv(document.getElementById("dvList"), listData[i]);
            }
        }
        function saveToList(item) {
            if (item.Id == null) {
                item.Id = getNextIndex();
                listData.push(item);
            }
            else {
                i = listData.findIndex((d => d.Id == item.Id));
                listData[i] = item;
            }
            return item;
        }
        function saveList() {
            setCache(listData);
        }
        function saveAsFile(data) {
            var a = document.createElement("a");
            a.download = "list";
            a.innerHTML = "export";
            a.href = window.URL.createObjectURL(new Blob([data], { type: "text/plain" }));
            a.style.display = "none";
            a.onclick = function (event) { document.body.removeChild(event.target); };
            document.body.appendChild(a);
            a.click();
        }

        function addToDiv(d, item, addToTop) {
            dv = document.createElement('div');            
            tb = document.createElement('input');
            tb.setAttribute("type", "text");
            tb.setAttribute("itemId", item.Id);
            tb.id = "tbType" + item.Id;
            tb.value = item.Type;
            tb.className = "type";
            tb.placeholder = "type";
            tb.addEventListener("blur", function () { saveItem(this); });
            dv.appendChild(tb);
            tb = document.createElement('input');
            tb.setAttribute("type", "text");
            tb.setAttribute("itemId", item.Id);
            tb.id = "tbName" + item.Id;
            tb.value = item.Name;
            tb.className = "name";
            tb.placeholder = "name";
            tb.addEventListener("blur", function () { saveItem(this); });
            dv.appendChild(tb);
            tb = document.createElement('input');
            tb.setAttribute("type", "text");
            tb.setAttribute("itemId", item.Id);
            tb.id = "tbRemark" + item.Id;
            tb.value = item.Remark;
            tb.className = "rem";
            tb.placeholder = "remark";
            tb.addEventListener("blur", function () { saveItem(this); });
            dv.appendChild(tb);
            tb = document.createElement('input');
            tb.setAttribute("type", "text");
            tb.setAttribute("itemId", item.Id);
            tb.id = "tbQuantity" + item.Id;
            tb.value = item.Quantity;
            tb.className = "qty";
            tb.placeholder = "quantity";
            tb.addEventListener("blur", function () { saveItem(this); });
            dv.appendChild(tb);
            tb = document.createElement('input');
            tb.setAttribute("type", "checkbox");
            tb.setAttribute("itemId", item.Id);
            tb.id = "cbBuy" + item.Id;
            tb.checked = item.Buy;
            dv.appendChild(tb);
            
            if(addToTop){
                d.insertBefore(dv, d.firstChild);
            } else{
                d.appendChild(dv);
            }
        }
        function saveItem(element) {
            id = element.getAttribute("itemId");
            item = {
                Id: id,
                Type: document.getElementById("tbType" + id).value,
                Name: document.getElementById("tbName" + id).value,
                Remark: document.getElementById("tbRemark" + id).value,
                Quantity: document.getElementById("tbQuantity" + id).value,
                Buy: document.getElementById("cbBuy" + id).checked
            }
            saveToList(item);
        }
        function addItem() {
            item = {Id: null, Type: null, Name: null, Remark: null, Quantity: null, Buy: false};
            item = saveToList(item);
            addToDiv(document.getElementById("dvList"), item, true);
        }
        function getNextIndex() {
            var index = localStorage.getItem("index_list");
            if (index == null) {
                index = 0;
            }
            else {
                index = parseInt(index);
            }
            index = index + 1;
            localStorage.setItem("index_list", index);
            return index;
        }
        function getCache() {
            var items = JSON.parse(localStorage.getItem("list"));
            if (items == null) {
                items = [];
            }
            return items;
        }
        function setCache(items) {
            localStorage.setItem("list", JSON.stringify(items));
        }
    </script>
</body>
</html>
